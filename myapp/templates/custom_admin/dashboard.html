{% extends "base.html" %}
{% load static %}

{% block title %}Admin Control Panel | ComradeGigs{% endblock %}

{% block content %}
<section class="py-5 bg-light">
  <div class="container">
    
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-5">
      <div class="mb-3 mb-md-0">
        <span class="badge bg-dark text-white rounded-pill px-3 py-2 mb-2">Superuser Access</span>
        <h2 class="fw-bold mb-0">Platform Administration</h2>
      </div>
      <div class="d-flex flex-wrap gap-2 justify-content-end">
        
        <button type="button" class="btn btn-danger rounded-pill fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#broadcastModal">
            <i class="bi bi-megaphone-fill me-2"></i>Broadcast Alert
        </button>

        <a href="{% url 'myapp:create_site_update' %}" class="btn btn-secondary rounded-pill fw-bold shadow-sm">
            <i class="bi bi-bell-fill me-2"></i>Post Update
        </a>

        <a href="{% url 'myapp:event_create' %}" class="btn btn-info text-white rounded-pill fw-bold shadow-sm">
            <i class="bi bi-calendar-plus-fill me-2"></i>Post Event
        </a>

        <a href="{% url 'myapp:job_create' %}" class="btn btn-warning rounded-pill fw-bold shadow-sm">
          <i class="bi bi-briefcase-fill me-2"></i>Post Admin Gig
        </a>

        <a href="{% url 'myapp:admin_users' %}" class="btn btn-dark rounded-pill fw-bold shadow-sm">
          <i class="bi bi-people-fill me-2"></i>Manage Users
        </a>
      </div>
    </div>

    <div class="row g-4 mb-5">
      <div class="col-md-3">
        <div class="card border-0 shadow-sm rounded-4 h-100 p-3 bg-success bg-opacity-10">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="text-success text-uppercase small fw-bold mb-0">User Base</h6>
                    <div class="bg-white rounded-circle p-2 shadow-sm text-success">
                        <i class="bi bi-people-fill fs-4"></i>
                    </div>
                </div>
                <h2 class="fw-bold mb-0 text-success">{{ total_users_count|default:"0" }}</h2>
                <div class="mt-4">
                    <a href="{% url 'myapp:admin_users' %}" class="btn btn-success text-white btn-sm rounded-pill fw-bold shadow-sm w-100">
                        View All Users
                    </a>
                </div>
            </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm rounded-4 h-100 p-3 bg-warning bg-opacity-10">
          <div class="card-body">
            <h6 class="text-dark text-uppercase small fw-bold mb-3">Pending Approval</h6>
            <h2 class="fw-bold mb-0 text-dark">{{ pending_gigs_count|default:"0" }}</h2>
            <div class="mt-3">
                <a href="{% url 'myapp:admin_verify_gigs' %}" class="btn btn-warning btn-sm rounded-pill fw-bold shadow-sm w-100">
                    Verify Gigs
                </a>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm rounded-4 h-100 p-3 bg-info bg-opacity-10">
            <div class="card-body">
                <h6 class="text-dark text-uppercase small fw-bold mb-3">Skill Reviews</h6>
                <h2 class="fw-bold mb-0 text-dark">{{ pending_assessments_count|default:"0" }}</h2>
                <div class="mt-3">
                    <a href="{% url 'myapp:admin_verify_skills' %}" class="btn btn-info text-white btn-sm rounded-pill fw-bold shadow-sm w-100">
                        Verify Students
                    </a>
                </div>
            </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm rounded-4 h-100 p-3 bg-danger bg-opacity-10">
            <div class="card-body">
                <h6 class="text-danger text-uppercase small fw-bold mb-3">Expired Gigs</h6>
                <h2 class="fw-bold mb-0 text-danger">{{ expired_gigs_count|default:"0" }}</h2>
                <div class="mt-3">
                    <a href="{% url 'myapp:admin_manage_expired' %}" class="btn btn-danger text-white btn-sm rounded-pill fw-bold shadow-sm w-100">
                        Clean Up Now
                    </a>
                </div>
            </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white py-3 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-info"><i class="bi bi-calendar-event me-2"></i>Upcoming Events</h6>
                    <a href="{% url 'myapp:event_create' %}" class="btn btn-sm btn-outline-info rounded-circle"><i class="bi bi-plus-lg"></i></a>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for event in events %}
                        <div class="list-group-item px-4 py-3 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-0">{{ event.title }}</h6>
                                <small class="text-muted">{{ event.date|date:"M d, Y" }}</small>
                            </div>
                            <a href="{% url 'myapp:event_edit' event.id %}" class="btn btn-sm btn-light text-secondary rounded-circle" title="Edit Event">
                                <i class="bi bi-pencil-fill"></i>
                            </a>
                        </div>
                        {% empty %}
                        <div class="p-4 text-center text-muted small">No upcoming events posted.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-0 shadow-sm rounded-4 h-100 bg-warning bg-opacity-10 overflow-hidden" id="notifications-container">
                <div class="card-header bg-transparent border-0 py-3 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-dark"><i class="bi bi-bell-fill me-2 text-warning"></i>Important Updates</h6>
                    <a href="#" class="btn btn-sm btn-outline-warning rounded-circle"><i class="bi bi-plus-lg"></i></a>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush bg-transparent">
                        {% for update in site_updates %}
                        <div id="announcement-{{ update.id }}" class="list-group-item bg-transparent border-0 border-bottom border-warning border-opacity-25 px-4 py-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="fw-bold mb-1 text-dark">{{ update.title }}</h6>
                                    <p class="small text-secondary mb-1" style="line-height: 1.4;">{{ update.message }}</p>
                                    <small class="text-muted" style="font-size: 0.75rem;">
                                        Posted: {{ update.created_at|date:"M d" }}
                                    </small>
                                </div>
                                <div class="ms-2">
                                    <button type="button" 
                                            class="btn-close" 
                                            onclick="dismissUpdate({{ update.id }})"
                                            title="Dismiss">
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="p-4 text-center text-muted small">No active announcements.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100 p-3 bg-primary bg-opacity-10">
                <div class="card-body">
                    <h6 class="text-primary text-uppercase small fw-bold mb-1">Student Applications</h6>
                    <h2 class="fw-bold mb-0 text-primary">{{ pending_apps_count|default:"0" }}</h2>
                    <a href="{% url 'myapp:admin_manage_applications' %}" class="btn btn-primary btn-sm rounded-pill fw-bold shadow-sm w-100 mt-3">
                        Verify Applications
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if my_posted_jobs %}
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-5">
      <div class="card-header bg-dark text-white py-3 px-4 border-bottom d-flex justify-content-between align-items-center">
        <h6 class="fw-bold mb-0"><i class="bi bi-briefcase-fill me-2"></i>My Posted Gigs (Admin)</h6>
        <span class="badge bg-light text-dark rounded-pill">{{ my_posted_jobs.count }} Active</span>
      </div>
      <div class="list-group list-group-flush">
        {% for job in my_posted_jobs %}
        <div class="list-group-item p-4 border-bottom hover-bg-light">
          <div class="row align-items-center gy-3">
            
            <div class="col-lg-5">
              <div class="d-flex align-items-center gap-2 mb-1">
                  <h5 class="fw-bold text-dark mb-0">{{ job.title }}</h5>
                  {% if job.status == 'assigned' %}
                    <span class="badge bg-info text-dark rounded-pill small">In Progress</span>
                  {% elif job.status == 'completed' %}
                    <span class="badge bg-success rounded-pill small">Completed</span>
                  {% else %}
                    <span class="badge bg-secondary rounded-pill small">Open</span>
                  {% endif %}
              </div>
              <p class="text-muted small mb-0">Budget: <span class="text-success fw-bold">Ksh {{ job.budget }}</span></p>
              
              {% if job.assigned_to %}
                  <div class="mt-2 d-flex flex-wrap align-items-center gap-2">
                      <div class="bg-light rounded-circle text-primary d-flex justify-content-center align-items-center" style="width: 24px; height: 24px; font-size: 0.7rem;">
                          {{ job.assigned_to.username|slice:":1"|upper }}
                      </div>
                      <span class="small text-secondary">Hired: <strong>{{ job.assigned_to.username }}</strong></span>
                      
                      {% if job.assigned_to.phone_number %}
                        <a href="https://wa.me/{{ job.assigned_to.phone_number }}" target="_blank" class="btn btn-sm btn-outline-success rounded-pill py-0 px-2" style="font-size: 0.7rem;">
                            <i class="bi bi-whatsapp me-1"></i> Chat
                        </a>
                      {% endif %}

                      {% if job.assigned_to.email %}
                        <a href="mailto:{{ job.assigned_to.email }}" class="btn btn-sm btn-outline-dark rounded-pill py-0 px-2" style="font-size: 0.7rem;">
                            <i class="bi bi-envelope-fill me-1"></i> Email
                        </a>
                      {% endif %}
                  </div>
              {% endif %}
            </div>

            <div class="col-lg-7 text-start text-lg-end d-flex flex-wrap justify-content-lg-end align-items-center gap-2">
               
               {% if job.status == 'assigned' %}
                  <a href="{% url 'myapp:pay_for_job' job.id %}" class="btn btn-success btn-sm rounded-pill fw-bold px-4 shadow-sm">
                    <i class="bi bi-credit-card-2-front-fill me-2"></i>Pay Student
                  </a>
               {% elif job.status == 'open' %}
                  <a href="{% url 'myapp:applicant_review' job.id %}" class="btn btn-primary btn-sm rounded-pill px-3">
                    Review Applicants
                  </a>
               {% elif job.status == 'completed' %}
                  <span class="text-success fw-bold small border border-success rounded-pill px-3 py-1 bg-success bg-opacity-10">
                      <i class="bi bi-check-all me-1"></i>Paid
                  </span>
               {% endif %}
               
               <div class="vr mx-2 d-none d-lg-block"></div>

               <a href="{% url 'myapp:job_edit' job.id %}" class="btn btn-outline-secondary btn-sm rounded-pill" title="Edit Gig">
                 <i class="bi bi-pencil-fill"></i>
               </a>

               {% if job.status != 'assigned' and job.status != 'completed' %}
               <a href="{% url 'myapp:job_delete' job.id %}" 
                  class="btn btn-outline-danger btn-sm rounded-pill" 
                  title="Delete Gig"
                  onclick="return confirm('Are you sure you want to delete this admin gig?');">
                 <i class="bi bi-trash3-fill"></i>
               </a>
               {% endif %}

            </div>

          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>
</section>

<div class="modal fade" id="broadcastModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-danger text-white">
        <h5 class="fw-bold mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Broadcast System Alert</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="#"> 
        {% csrf_token %}
        <div class="modal-body p-4">
            <p class="text-muted small mb-3">
                This will send a notification or email to the selected user groups. Use strictly for maintenance or urgent updates.
            </p>
            <div class="mb-3">
                <label class="form-label fw-bold">Target Audience</label>
                <select class="form-select" name="audience">
                    <option value="all">All Users</option>
                    <option value="student">Students Only</option>
                    <option value="client">Clients Only</option>
                    <option value="donor">Donors Only</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Message Subject</label>
                <input type="text" name="subject" class="form-control" placeholder="e.g. Scheduled Maintenance Tonight" required>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Message Body</label>
                <textarea name="message" class="form-control" rows="4" placeholder="Enter your announcement here..." required></textarea>
            </div>
        </div>
        <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger rounded-pill fw-bold">
                <i class="bi bi-send-fill me-1"></i> Send Broadcast
            </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const dismissed = JSON.parse(localStorage.getItem('dismissedUpdates') || '[]');
        
        dismissed.forEach(function(id) {
            const el = document.getElementById('announcement-' + id);
            if (el) el.style.display = 'none';
        });

        // Hide container if empty
        checkIfEmpty();
    });

    function dismissUpdate(id) {
        const el = document.getElementById('announcement-' + id);
        if (el) {
            el.style.transition = "opacity 0.3s ease";
            el.style.opacity = "0";
            setTimeout(() => {
                el.style.display = 'none';
                checkIfEmpty();
            }, 300);
        }

        let dismissed = JSON.parse(localStorage.getItem('dismissedUpdates') || '[]');
        if (!dismissed.includes(id)) {
            dismissed.push(id);
            localStorage.setItem('dismissedUpdates', JSON.stringify(dismissed));
        }
    }

    function checkIfEmpty() {
        const container = document.getElementById('notifications-container');
        const visibleUpdates = document.querySelectorAll('[id^="announcement-"]:not([style*="display: none"])');
        
        // Note: The logic here is slightly different because the admin panel might show 'No announcements' text
        // If you want to hide the whole card when user dismisses everything:
        if (visibleUpdates.length === 0 && container) {
             // container.style.display = 'none'; // Uncomment this to hide the whole card
        }
    }
</script>

{% endblock %}