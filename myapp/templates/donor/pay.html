{% extends "base.html" %}

{% block content %}
<div class="container py-5 text-center">
    <div class="card shadow-lg p-5 mx-auto" style="max-width: 500px;">
        
        <div class="mb-4">
            <div class="spinner-border text-success" role="status" style="width: 4rem; height: 4rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <h3 class="fw-bold">Check your phone!</h3>
        <p class="lead">We sent an M-Pesa prompt to <strong>{{ phone_number }}</strong>.</p>
        <p class="text-muted small">Enter your PIN to complete the transaction.</p>

        <hr class="my-4">

        <div id="status-message" class="alert alert-info">
            <i class="bi bi-hourglass-split"></i> Waiting for payment confirmation...
        </div>

        <a id="success-btn" href="{% url 'myapp:donate_success' %}" class="btn btn-success w-100 rounded-pill fw-bold d-none">
            Payment Received! Click to Continue
        </a>

    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const paymentId = "{{ payment.id }}";
        const checkUrl = "{% url 'myapp:check_payment_status' 0 %}".replace('0', paymentId);
        const statusMsg = document.getElementById("status-message");
        const successBtn = document.getElementById("success-btn");
        let checks = 0;

        // Function to ask server: "Is it paid yet?"
        const checkStatus = setInterval(() => {
            fetch(checkUrl)
                .then(response => response.json())
                .then(data => {
                    console.log("Payment Status:", data.status);

                    if (data.status === 'SUCCESS') {
                        // STOP checking
                        clearInterval(checkStatus);
                        
                        // Show Success
                        statusMsg.className = "alert alert-success";
                        statusMsg.innerHTML = "<i class='bi bi-check-circle-fill'></i> Payment Confirmed!";
                        successBtn.classList.remove("d-none");
                        
                        // Optional: Auto-redirect after 2 seconds
                        setTimeout(() => {
                            window.location.href = "{% url 'myapp:donate_success' %}";
                        }, 2000);
                    } 
                    else if (data.status === 'FAILED') {
                        clearInterval(checkStatus);
                        statusMsg.className = "alert alert-danger";
                        statusMsg.innerHTML = "Payment Failed or Canceled.";
                    }
                });

            // Stop checking after 60 seconds (timeout)
            checks++;
            if (checks > 20) {
                clearInterval(checkStatus);
                statusMsg.innerHTML = "Taking too long? Check your dashboard manually.";
            }
        }, 3000); // Check every 3 seconds
    });
</script>
{% endblock %}